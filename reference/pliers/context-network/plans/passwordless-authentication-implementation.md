# Passwordless Authentication Implementation Plan

## Classification
- **Domain:** Authentication/Security Implementation
- **Stability:** Semi-stable - based on established research
- **Abstraction:** Structural
- **Confidence:** High

## Executive Summary

Based on comprehensive research, implement hybrid passwordless authentication for the Pliers platform using:
1. **Passkeys (WebAuthn/FIDO2)** for security-conscious users and modern devices
2. **Email Magic Links** for broader compatibility and easier onboarding

## Strategic Approach: Progressive Enhancement

### Phase 1: Foundation (Weeks 1-2)
**Goal:** Establish authentication infrastructure without disrupting existing system

**Implementation:**
- Extend existing JWT-based authentication to support passwordless tokens
- Add database schema for both passkey credentials and magic link tokens
- Implement feature detection for WebAuthn capability
- Create basic email infrastructure for magic links

**Success Criteria:**
- Authentication endpoints ready for both methods
- Database migrations successful
- Email delivery configured and tested
- No disruption to existing password-based authentication

### Phase 2: Magic Links First (Weeks 3-4)
**Goal:** Deploy magic link authentication as password alternative

**Implementation:**
- Magic link generation and verification endpoints
- Email templates and delivery optimization
- Rate limiting and security controls
- User onboarding flow for magic links

**Success Criteria:**
- Users can request magic links for login
- Secure token generation and validation
- Email delivery >95% within 30 seconds
- Rate limiting prevents abuse

### Phase 3: Passkey Integration (Weeks 5-8)
**Goal:** Add passkey support with graceful fallbacks

**Implementation:**
- WebAuthn registration and authentication flows
- Client-side passkey management UI
- Cross-device synchronization handling
- Recovery mechanisms for lost devices

**Success Criteria:**
- Users can register and use passkeys
- Cross-browser compatibility verified
- Fallback to magic links works seamlessly
- Device management interface functional

### Phase 4: User Experience Optimization (Weeks 9-10)
**Goal:** Optimize flows based on device capabilities and user preferences

**Implementation:**
- Intelligent method recommendation based on device capabilities
- Progressive disclosure of authentication options
- User preference persistence
- Performance optimization

**Success Criteria:**
- Authentication method recommendations work correctly
- User preferences are remembered
- Authentication time <5 seconds average
- High user satisfaction scores

## Technical Architecture

### Database Schema Extensions

#### Passkey Credentials
```sql
CREATE TABLE user_credentials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  credential_id TEXT UNIQUE NOT NULL,
  public_key TEXT NOT NULL,
  counter INTEGER DEFAULT 0,
  device_name TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  last_used_at TIMESTAMP,
  is_active BOOLEAN DEFAULT true
);

CREATE INDEX idx_user_credentials_user_id ON user_credentials(user_id);
CREATE INDEX idx_user_credentials_active ON user_credentials(user_id, is_active);
```

#### Magic Link Tokens
```sql
CREATE TABLE magic_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  token_hash TEXT UNIQUE NOT NULL,
  action_type VARCHAR(50) NOT NULL CHECK (action_type IN ('login', 'register')),
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'
);

CREATE INDEX idx_magic_tokens_hash ON magic_tokens(token_hash);
CREATE INDEX idx_magic_tokens_cleanup ON magic_tokens(expires_at) WHERE used_at IS NULL;
```

### API Endpoints Design

#### Passkey Endpoints
```
POST /api/auth/passkey/register/begin    # Start passkey registration
POST /api/auth/passkey/register/finish   # Complete passkey registration
POST /api/auth/passkey/login/begin       # Start passkey authentication
POST /api/auth/passkey/login/finish      # Complete passkey authentication
GET  /api/auth/passkey/credentials       # List user's passkeys
DELETE /api/auth/passkey/credentials/:id # Delete specific passkey
```

#### Magic Link Endpoints
```
POST /api/auth/magic-link/request        # Request magic link
GET  /api/auth/magic-link/verify/:token  # Verify magic link token
POST /api/auth/magic-link/resend         # Resend magic link
```

#### Capability Detection
```
GET /api/auth/capabilities               # Get supported auth methods for client
```

### Integration with Existing WebSocket Authentication

**Current State:** WebSocket authentication uses JWT tokens from HTTP authentication

**Enhancement:** Extend WebSocket auth to accept tokens generated by passwordless methods

```typescript
// In src/lib/event-engine/websocket-auth.ts
async authenticateWebSocketConnection(info: any) {
  const token = this.extractTokenFromRequest(info.req);

  // Existing JWT validation
  if (this.isJWTToken(token)) {
    return this.validateJWTToken(token);
  }

  // New: Passwordless token validation
  if (this.isPasswordlessToken(token)) {
    return this.validatePasswordlessToken(token);
  }

  return { authenticated: false, user: null };
}
```

## Implementation Priorities

### High Priority (Must Have)
1. **Security First:** All tokens cryptographically secure, short-lived
2. **Backwards Compatibility:** No disruption to existing password authentication
3. **Rate Limiting:** Prevent abuse of magic link generation
4. **Error Handling:** Graceful failures with clear user guidance

### Medium Priority (Should Have)
1. **Device Management:** Users can see and manage their passkeys
2. **Cross-Device Sync:** Passkey synchronization across user's devices
3. **Accessibility:** Screen reader compatibility for authentication flows
4. **Performance:** Sub-5-second authentication times

### Lower Priority (Nice to Have)
1. **Advanced Security:** Device attestation validation
2. **Analytics:** Authentication method usage statistics
3. **Enterprise Features:** Advanced credential management
4. **Internationalization:** Multi-language support for emails

## Security Considerations

### Magic Link Security
- **Token Generation:** 256+ bit cryptographically secure random tokens
- **Token Storage:** Store hashed tokens, never plaintext
- **Expiration:** 5-15 minute token lifespans
- **Single Use:** Tokens invalidated after first use
- **Rate Limiting:** Max 3-5 tokens per hour per user
- **Email Security:** SPF, DKIM, DMARC configured
- **HTTPS Only:** All verification endpoints require TLS

### Passkey Security
- **Origin Validation:** Strict origin checking in WebAuthn ceremonies
- **User Verification:** Appropriate UV policy for security requirements
- **Credential Management:** Secure deletion and replacement procedures
- **Error Messages:** No information leakage in error responses
- **Fallback Security:** Magic links available when passkeys fail

## Risk Management

### High Risk Mitigations
1. **Email Compromise Risk:** Short token lifespans, single-use enforcement
2. **Device Loss Risk:** Multiple recovery options, account recovery procedures
3. **Implementation Bugs:** Comprehensive testing, security review
4. **User Adoption Risk:** Progressive enhancement, clear onboarding

### Monitoring and Alerting
- Authentication success/failure rates
- Token generation and usage patterns
- Email delivery performance
- Error rates by authentication method
- User adoption metrics

## Dependencies

### External Services
- **Email Delivery:** SendGrid, AWS SES, or similar service
- **DNS Configuration:** SPF, DKIM, DMARC records
- **SSL Certificates:** Valid HTTPS for WebAuthn

### Libraries and Tools
- **SimpleWebAuthn:** For WebAuthn implementation
- **Node.js crypto:** For secure token generation
- **Email templates:** HTML/text templates for magic links

## Success Metrics

### Technical Metrics
- Authentication success rate: >99.5%
- Average authentication time: <5 seconds
- Email delivery rate: >95% within 30 seconds
- System uptime during auth: 99.9%

### User Experience Metrics
- User onboarding completion rates
- Authentication method preference distribution
- Support ticket reduction from password issues
- User satisfaction scores

### Security Metrics
- Reduction in authentication-related incidents
- Successful attack prevention rates
- Account takeover incident reduction
- Time-to-resolution for security issues

## Implementation Timeline

### Immediate Next Steps (Week 1)
1. Create database migration scripts
2. Set up email infrastructure
3. Implement basic token generation
4. Create authentication service interface

### Short Term (Weeks 2-4)
1. Complete magic link implementation
2. Add WebSocket authentication extension
3. Create user onboarding flows
4. Implement security controls

### Medium Term (Weeks 5-8)
1. WebAuthn passkey implementation
2. Cross-browser compatibility testing
3. Device management interface
4. Performance optimization

### Long Term (Weeks 9-12)
1. User experience refinement
2. Advanced security features
3. Analytics and monitoring
4. Documentation and training

This implementation plan provides a systematic approach to adding passwordless authentication to the Pliers platform while maintaining security, compatibility, and user experience standards.