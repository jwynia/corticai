# WEB-007-3: Passkey Authentication Flow

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** web-auth
- **Priority:** high
- **Size:** medium
- **Estimated Effort:** 4-5 days
- **Created:** 2025-09-30
- **Parent Task:** WEB-007 (archived - oversized)
- **Branch:** feat/WEB-007-3-passkey-auth-flow

## Description
Implement the complete passkey (WebAuthn) authentication flow for both registration and login. This includes WebAuthn API integration, user prompts, error handling, and fallback options for unsupported devices or failed attempts.

## Acceptance Criteria
- [ ] Implement passkey registration flow with WebAuthn API
- [ ] Create passkey login flow
- [ ] Add waiting states during biometric prompt
- [ ] Implement error handling and user guidance
- [ ] Support fallback to other methods on failure

## Technical Notes
- Use WebAuthn PublicKeyCredential API
- Integration with AUTH-004 backend API endpoints
- Handle browser-specific WebAuthn implementations
- Provide clear user guidance during biometric prompts

## Implementation Approach
```typescript
const PasskeyAuthFlow = ({
  mode,
  onSuccess,
  onError,
  onFallback
}: {
  mode: 'login' | 'register';
  onSuccess: (result: any) => void;
  onError: (error: string) => void;
  onFallback: () => void;
}) => {
  const [step, setStep] = useState<'prompt' | 'waiting' | 'success' | 'error'>('prompt');

  const handlePasskeyAuth = async () => {
    setStep('waiting');

    try {
      if (mode === 'register') {
        // Get challenge from server
        const options = await apiClient.auth.getPasskeyRegistrationOptions();

        // Create credential
        const credential = await navigator.credentials.create({
          publicKey: options
        });

        // Send to server
        const result = await apiClient.auth.registerPasskey(credential);
        onSuccess(result);
        setStep('success');
      } else {
        // Get challenge from server
        const options = await apiClient.auth.getPasskeyLoginOptions();

        // Get credential
        const credential = await navigator.credentials.get({
          publicKey: options
        });

        // Verify with server
        const result = await apiClient.auth.verifyPasskey(credential);
        onSuccess(result);
        setStep('success');
      }
    } catch (error) {
      console.error('Passkey error:', error);
      onError(error.message);
      setStep('error');
    }
  };

  return (
    <div className="passkey-auth-flow">
      {step === 'prompt' && <PasskeyPrompt onContinue={handlePasskeyAuth} onFallback={onFallback} />}
      {step === 'waiting' && <PasskeyWaiting onCancel={() => setStep('prompt')} />}
      {step === 'error' && <PasskeyError onRetry={() => setStep('prompt')} onFallback={onFallback} />}
    </div>
  );
};
```

## Dependencies
- WEB-007-1: Authentication Context (auth state)
- WEB-003: API Client (passkey endpoints)
- AUTH-004: Passkey Backend Implementation (completed)

## Follows After
- WEB-007-2: Authentication Method Selector

## Enables
- Complete passwordless authentication

## Testing Strategy
- Integration tests with WebAuthn API
- Test both registration and login flows
- Verify error handling for all failure cases
- Test on multiple browsers and devices
- Mock WebAuthn API for unit tests

## Success Metrics
- Passkey registration creates credential
- Passkey login authenticates successfully
- Error states display helpful messages
- Fallback options work when needed
- Flow works across supported browsers

## Branch Naming
`feat/WEB-007-3-passkey-auth-flow`