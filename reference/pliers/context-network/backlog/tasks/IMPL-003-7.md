# IMPL-003-7: Extended Authentication Methods

## Metadata
- **Status:** ready
- **Type:** feat
- **Epic:** phase-2-core-engines
- **Priority:** medium
- **Size:** medium
- **Created:** 2025-10-02
- **Parent:** IMPL-003 (decomposed)

## Branch Info
- **Branch:** [not yet created]
- **Worktree:** [not yet created]
- **PR:** [not yet created]

## Description
Implement extended authentication methods including API key authentication for service-to-service communication, OAuth2/OIDC integration preparation, and 2FA foundation with TOTP support.

## Acceptance Criteria
- [ ] API key generation and validation for services
- [ ] API key authentication middleware
- [ ] OAuth2/OIDC provider configuration interface
- [ ] 2FA TOTP enrollment and verification endpoints
- [ ] 2FA enforcement configuration per user/tenant

## Technical Notes

### Implementation Scope
1. **API Key Authentication**
   - Generate API keys for service accounts
   - API key hashing and storage
   - API key authentication middleware
   - Scope and permission assignment to API keys
   - API key rotation and revocation
   - Usage tracking and logging

2. **OAuth2/OIDC Preparation**
   - Provider configuration model (Google, GitHub, Microsoft, etc.)
   - OAuth2 callback endpoint structure
   - User account linking strategy
   - External identity storage schema
   - Provider-agnostic interface design

3. **2FA TOTP Foundation**
   - TOTP secret generation and storage
   - QR code generation for authenticator apps
   - TOTP verification endpoint
   - 2FA enrollment flow
   - Recovery codes generation
   - 2FA enforcement policies

4. **Authentication Strategy Selection**
   - Detect authentication method from request
   - Support multiple auth methods on same route
   - Auth method priority and fallback
   - Auth method audit logging

### Files to Create/Modify
- `packages/api/src/auth/api-key/api-key.service.ts` - API key management
- `packages/api/src/auth/api-key/api-key.middleware.ts` - API key validation
- `packages/api/src/auth/oauth/oauth-provider.model.ts` - OAuth configuration
- `packages/api/src/auth/oauth/oauth.service.ts` - OAuth logic (preparation)
- `packages/api/src/auth/2fa/totp.service.ts` - TOTP operations
- `packages/api/src/auth/2fa/2fa.routes.ts` - 2FA endpoints
- Database migrations for api_keys, oauth_providers, user_2fa

### Database Schema
```sql
CREATE TABLE api_keys (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  key_hash VARCHAR(255) NOT NULL UNIQUE,
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  scopes JSONB DEFAULT '[]',
  expires_at TIMESTAMP,
  last_used_at TIMESTAMP,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  revoked_at TIMESTAMP
);

CREATE TABLE oauth_providers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  provider_name VARCHAR(50) NOT NULL,
  client_id VARCHAR(255) NOT NULL,
  client_secret_encrypted TEXT NOT NULL,
  config JSONB,
  enabled BOOLEAN DEFAULT true
);

CREATE TABLE user_2fa (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  totp_secret_encrypted TEXT,
  recovery_codes_encrypted TEXT,
  enabled BOOLEAN DEFAULT false,
  enrolled_at TIMESTAMP,
  last_verified_at TIMESTAMP
);
```

## Branch Naming
**Suggested Branch:** `task/IMPL-003-7-extended-auth-methods`

## Dependencies
- ✅ IMPL-003-2: JWT Authentication Foundation (MUST COMPLETE FIRST)
- ✅ IMPL-003-4: RBAC System (API key scopes use permissions)
- ✅ IMPL-003-6: Security Hardening (rate limiting on 2FA)

## Testing Strategy

### Unit Tests Required
1. **API Key Service Tests**
   - Generate API key
   - Validate API key
   - Revoke API key
   - Check API key scopes
   - API key expiration

2. **API Key Middleware Tests**
   - Valid API key allows access
   - Invalid API key blocks access
   - Expired API key blocks access
   - Revoked API key blocks access
   - Scope validation

3. **TOTP Service Tests**
   - Generate TOTP secret
   - Verify valid TOTP code
   - Reject invalid TOTP code
   - Reject expired TOTP code
   - Recovery code generation and validation

4. **2FA Endpoint Tests**
   - Enroll 2FA successfully
   - Verify 2FA code
   - Use recovery code
   - Disable 2FA

### Integration Tests
- API key authentication flow
- 2FA enrollment and login flow
- OAuth provider configuration (prep only, no real OAuth flow yet)

### Security Tests
1. **API Key Security**
   - API key not exposed in logs
   - API key hashed in database
   - Revoked keys can't be used

2. **2FA Security**
   - TOTP secret encrypted at rest
   - TOTP codes expire after 30 seconds
   - Recovery codes single-use
   - Time-based attack prevention

## Estimated Effort
- **Time:** 2-3 days
- **Complexity:** Medium
- **Files:** 8-12 files (new + modifications + migrations)
- **Lines:** 450-550 lines total

## Notes
This task focuses on **preparation and foundation** for extended auth methods:
- API keys are fully functional
- 2FA TOTP is fully functional
- OAuth2/OIDC is **interface/schema only** - actual provider integration is future work

## Follow-up Tasks
- Future: Implement specific OAuth2 providers (Google, GitHub, etc.)
- Future: WebAuthn/Passkey support (may overlap with AUTH-004)
- Future: SMS-based 2FA (if required)
