# BUG-001: Fix Incorrect Total Count in listForms Method

## Metadata
- **Status:** completed
- **Type:** bug
- **Epic:** form-engine
- **Priority:** high
- **Size:** small
- **Created:** 2025-09-23
- **Completed:** 2025-09-25
- **Branch:** task/BUG-001-fix-listforms-count
- **Worktree:** .worktrees/BUG-001/
- **PR:** https://github.com/jwynia/pliers/pull/9

## Description
The `listForms` method returns the current page's item count as the total, not the actual total count from the database. This breaks pagination calculations.

**Location:** `apps/api/src/services/form-engine/form-engine.ts:218`

## Current Issue
```javascript
return {
  items: formModels,
  total: formModels.length,  // Wrong! This is page count
  page,
  limit,
  pages: Math.ceil(formModels.length / limit),  // Always 1!
};
```

## Acceptance Criteria
- [ ] Add separate count query to get total records
- [ ] Return correct total count in response
- [ ] Fix pages calculation to use actual total
- [ ] Add test for pagination with multiple pages
- [ ] Verify filtering works with count query

## Recommended Solution
```javascript
// Get total count
const [{ count }] = await db
  .select({ count: sql`count(*)::int` })
  .from(forms)
  .where(/* same conditions as main query */);

return {
  items: formModels,
  total: count,
  page,
  limit,
  pages: Math.ceil(count / limit),
};
```

## Testing Requirements
- Test with 0 items
- Test with items less than page size
- Test with multiple pages
- Test with filtered results
- Test pagination boundaries

## Implementation Summary
✅ **Fixed in commit a79adbd**

### Changes Made:
1. **Updated imports**: Added `sql` from drizzle-orm for count queries
2. **Added separate count query**: Duplicate filter logic to get accurate total
3. **Fixed pagination calculation**: Use actual count instead of page count
4. **Maintained filter consistency**: Count query uses same filters as main query

### Code Changes:
- **File**: `apps/api/src/services/form-engine/form-engine.ts`
- **Lines**: 1, 219-242 (import + count query implementation)
- **Tests**: Added 6 comprehensive test cases in `form-engine.test.ts`

### Performance Impact:
- One additional lightweight count query per listForms call
- Query is optimized with same indexes as main query
- Minimal overhead for significant functionality improvement

### Validation:
- All acceptance criteria met ✅
- TDD approach followed (tests first, then implementation)
- No breaking changes to API contract