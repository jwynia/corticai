# DOC-003-2: JSONB Schema Patterns and Validation

## Metadata
- **Status:** ready
- **Type:** doc
- **Epic:** phase-1-foundation
- **Priority:** high
- **Size:** medium
- **Created:** 2025-01-22
- **Updated:** 2025-01-22
- **Groomed:** 2025-09-23

## Branch Info
- **Branch:** feat/doc-003-2-jsonb-patterns
- **Worktree:** [will be set during implementation]
- **PR:** #pending

## Description
Define standardized JSONB structures for form definitions, submission data, workflow configurations, and event payloads. Create validation patterns using PostgreSQL constraints and application-level Zod schemas.

## Acceptance Criteria
- [ ] Form definition JSONB structure documented
- [ ] Submission data JSONB structure defined
- [ ] Workflow configuration JSONB schema
- [ ] Event payload JSONB patterns
- [ ] PostgreSQL CHECK constraints specified
- [ ] Zod schema validation patterns
- [ ] JSONB query patterns documented
- [ ] GIN index strategies for JSONB
- [ ] Schema versioning approach defined
- [ ] Migration patterns for JSONB changes

## Technical Notes
- Use JSON Schema for validation where possible
- Create reusable JSONB type definitions
- Document common query patterns
- Optimize for both storage and query performance

### Research-Based Implementation Guidance (2025-09-23)

#### PostgreSQL JSONB Validation Patterns
- **CHECK Constraints with jsonb_typeof**: Enforce specific JSON types
  ```sql
  CHECK (jsonb_typeof(config) = 'object')
  ```
- **Required Fields Validation**: Use path existence operators
  ```sql
  CHECK (data ? 'id' AND data ? 'type' AND data ? 'version')
  ```
- **Custom Validation Functions**: Create immutable SQL functions for complex logic
  ```sql
  CREATE FUNCTION validate_form_schema(data JSONB) RETURNS BOOLEAN AS $$
    -- Complex validation logic here
  $$ LANGUAGE SQL IMMUTABLE;

  CHECK (validate_form_schema(form_definition))
  ```
- **Composite Validation**: Combine multiple strategies for comprehensive validation

#### Recommended Schema Patterns
1. **Form Definitions**: Use nested objects with type annotations
2. **Event Payloads**: Include version field for schema evolution
3. **Submission Data**: Validate against form definition schema
4. **Query Optimization**: Use GIN indexes with jsonb_path_ops

See [Technical Research Findings](../../discoveries/records/2025-09-23-technical-research.md#postgresql-jsonb-validation-patterns) for detailed examples.

## Dependencies
- DOC-003-1: Core database schema design (âœ… COMPLETED)

## Testing Strategy
- JSONB validation tests
  - Valid/invalid structure tests for each pattern
  - CHECK constraint validation tests
  - Custom function validation tests
- Query performance tests
  - GIN index performance benchmarks
  - Complex path query optimization tests
  - Bulk operation performance tests
- Schema migration tests
  - Forward migration validation
  - Rollback capability tests
  - Data preservation during migration
- Edge case handling tests
  - Deeply nested structures
  - Large payload handling
  - Concurrent update scenarios
  - Null/undefined value handling