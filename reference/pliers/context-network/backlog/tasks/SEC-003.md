# SEC-003: Fix Code Injection Vulnerability in parseExpression

## Metadata
- **Status:** completed
- **Type:** security
- **Epic:** security-hardening
- **Priority:** critical
- **Size:** medium
- **Created:** 2025-09-23
- **Completed:** 2025-09-23

## Completion Info
- **PR:** #4 (merged with IMPL-002)
- **Fixed In:** Same PR as IMPL-002
- **Security Tests:** 17 comprehensive test cases added

## Description
The `parseExpression` method in ConditionalLogicEngine uses `new Function()` with user-controlled data, creating a severe code injection vulnerability. This allows attackers to execute arbitrary JavaScript code.

**Location:** `apps/api/src/services/form-engine/conditional-logic-engine.ts:152`

## Current Implementation
```javascript
// VULNERABLE CODE
const func = new Function('return ' + processedExpression);
return func();
```

## Acceptance Criteria
- [ ] Replace `new Function()` with safe expression evaluator
- [ ] Add comprehensive test coverage for malicious inputs
- [ ] Ensure all existing expressions still work
- [ ] Add security documentation for expression syntax
- [ ] Benchmark performance impact of safe parser
- [ ] Add input validation for expression syntax

## Recommended Solution
Use a safe expression evaluator library like `expr-eval`:
```javascript
import { Parser } from 'expr-eval';
const parser = new Parser();
try {
  const expr = parser.parse(processedExpression);
  return expr.evaluate(data);
} catch (error) {
  logger.warn('Invalid expression', { expression, error });
  return false;
}
```

## Security Testing Required
- Test with JavaScript injection attempts
- Test with system command injection
- Test with infinite loops
- Test with memory exhaustion attacks
- Verify sandbox cannot be escaped

## Dependencies
- Will need to add `expr-eval` or similar library
- Requires security review before deployment

## Risk Assessment
- **Current Risk:** CRITICAL - Remote code execution possible
- **After Fix:** LOW - Safe expression evaluation only
- **Testing Required:** Extensive security testing needed