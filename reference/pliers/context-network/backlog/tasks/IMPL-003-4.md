# IMPL-003-4: RBAC System Implementation

## Metadata
- **Status:** ready
- **Type:** feat
- **Epic:** phase-2-core-engines
- **Priority:** high
- **Size:** medium
- **Created:** 2025-10-02
- **Parent:** IMPL-003 (decomposed)

## Branch Info
- **Branch:** [not yet created]
- **Worktree:** [not yet created]
- **PR:** [not yet created]

## Description
Implement Role-Based Access Control (RBAC) system with hierarchical roles, permission inheritance, and authorization middleware. This provides fine-grained access control throughout the application.

## Acceptance Criteria
- [ ] Role model with hierarchical structure
- [ ] Permission model with granular actions
- [ ] Role-permission assignments
- [ ] Authorization middleware for permission checks
- [ ] Permission inheritance from role hierarchy

## Technical Notes

### Implementation Scope
1. **Role Model**
   - Create role database model
   - Hierarchical role structure (parent-child relationships)
   - Built-in roles: admin, manager, user, guest
   - Custom role creation and management
   - Role assignment to users

2. **Permission Model**
   - Permission database model
   - Resource-action pattern (e.g., "users:read", "posts:write")
   - Permission scopes (global, tenant, resource-specific)
   - Permission wildcards (e.g., "users:*", "*:read")

3. **Authorization Middleware**
   - Check user has required permission
   - Support multiple permission modes (AND/OR)
   - Resource-specific permission checks
   - Tenant-scoped permission validation
   - Clear error messages for authorization failures

4. **Permission Service**
   - Check if user has permission
   - Get all user permissions (with inheritance)
   - Get all user roles (with hierarchy)
   - Cache permission lookups for performance

### Files to Create/Modify
- `packages/api/src/auth/rbac/role.model.ts` - Role database model
- `packages/api/src/auth/rbac/permission.model.ts` - Permission model
- `packages/api/src/auth/rbac/permission.service.ts` - Permission logic
- `packages/api/src/auth/rbac/authorization.middleware.ts` - Route protection
- `packages/api/src/auth/rbac/types.ts` - RBAC type definitions
- Database migrations for roles, permissions, and junction tables

### Database Schema
```sql
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL UNIQUE,
  description TEXT,
  parent_role_id UUID REFERENCES roles(id),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  resource VARCHAR(100) NOT NULL,
  action VARCHAR(50) NOT NULL,
  scope VARCHAR(50) DEFAULT 'global',
  UNIQUE(resource, action, scope)
);

CREATE TABLE role_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE user_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  tenant_id UUID,
  PRIMARY KEY (user_id, role_id, COALESCE(tenant_id, '00000000-0000-0000-0000-000000000000'::uuid))
);
```

## Branch Naming
**Suggested Branch:** `task/IMPL-003-4-rbac-system`

## Dependencies
- ✅ IMPL-003-2: JWT Authentication Foundation (MUST COMPLETE FIRST)
- ✅ IMPL-003-1: Authentication System Assessment

## Testing Strategy

### Unit Tests Required
1. **Role Service Tests**
   - Create role
   - Get role hierarchy
   - Assign role to user
   - Remove role from user
   - Role inheritance logic

2. **Permission Service Tests**
   - Create permission
   - Assign permission to role
   - Check user has permission (direct)
   - Check user has permission (inherited)
   - Wildcard permission matching
   - Permission caching

3. **Authorization Middleware Tests**
   - Allow access with valid permission
   - Deny access without permission
   - Deny access with insufficient permission
   - Multiple permission requirements (AND)
   - Multiple permission requirements (OR)
   - Tenant-scoped permission checks

### Integration Tests
- Full RBAC flow: assign role → check permission → access resource
- Role hierarchy permission inheritance
- Multiple roles per user
- Permission revocation

### Edge Cases
- User with no roles
- Role with no permissions
- Circular role hierarchies (should prevent)
- Wildcard permission conflicts

## Estimated Effort
- **Time:** 2-3 days
- **Complexity:** Medium
- **Files:** 6-10 files (new + modifications + migrations)
- **Lines:** 400-500 lines total

## Follow-up Tasks
- IMPL-003-5: Multi-Tenancy Row-Level Security (uses RBAC for tenant permissions)
- IMPL-003-6: Security Hardening (adds permission auditing)
