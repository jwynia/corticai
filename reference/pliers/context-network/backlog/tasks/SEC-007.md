# SEC-007: Implement Structured Logging for WebSocket Auth

## Metadata
- **Status:** ready
- **Type:** improvement
- **Epic:** observability
- **Priority:** medium
- **Size:** small
- **Created:** 2025-09-24
- **Branch:** task/SEC-007-structured-logging

## Description
The WebSocket authentication module has placeholder TODO comments where logging should be implemented. Need to add proper structured logging with appropriate data redaction for security.

## Acceptance Criteria
- [ ] Implement structured logging utility with:
  - Log levels: debug, info, warn, error, critical
  - Automatic timestamp and correlation ID injection
  - JSON output format for log aggregation
- [ ] Add logging for key events:
  - Authentication success/failure (with reason codes)
  - Authorization checks (granted/denied)
  - Rate limit violations
  - WebSocket lifecycle (connect/disconnect)
  - Token refresh attempts
  - Malicious input detection
- [ ] Implement data redaction functions:
  - `sanitizeUserId()` - show first 8 chars + hash
  - `hashIp()` - use SHA-256 with daily salt
  - `sanitizeError()` - remove stack traces in production
  - `sanitizeEventType()` - escape special characters
  - `redactToken()` - show only last 4 characters
- [ ] Performance requirements:
  - < 1ms overhead per log statement
  - Async logging to prevent blocking
  - Log rotation support

## Technical Notes
- TODO comments located at lines 375, 379, 383, 496, 500, 574
- Need to implement:
  - `sanitizeUserId()` - hash or truncate user IDs
  - `hashIp()` - hash IP addresses for privacy
  - `sanitizeError()` - remove sensitive data from errors
  - `sanitizeEventType()` - ensure no injection in logs

## Dependencies
- SEC-004: WebSocket Authentication (completed)
- Consider using existing logging library (winston, pino)

## Implementation Notes
```typescript
// Structured logger setup:
import pino from 'pino';

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  redact: {
    paths: ['password', 'token', 'secret', 'authorization'],
    censor: '[REDACTED]'
  },
  serializers: {
    user: (user) => ({
      id: sanitizeUserId(user.id),
      roles: user.roles?.length || 0,
      // Never log email or PII
    }),
    error: pino.stdSerializers.err,
    req: (req) => ({
      method: req.method,
      url: req.url,
      ip: hashIp(req.socket.remoteAddress),
      correlationId: req.headers['x-correlation-id']
    })
  }
});

// Replace TODO comments with:
// Line 375: logger.info('WebSocket authenticated', { user, correlationId });
// Line 379: logger.warn('Authentication failed', { reason: 'invalid_token', ip });
// Line 383: logger.error('Authorization denied', { userId, eventType, permissions });
// Line 496: logger.warn('Rate limit exceeded', { userId, limit, window });
// Line 500: logger.info('Message received', { type: msg.type, userId });
// Line 574: logger.info('WebSocket closed', { userId, duration, reason });
```

## Testing Strategy
- Security tests:
  - Verify passwords never appear in logs
  - Check tokens are properly redacted
  - Ensure user PII is not logged
  - Test IP hashing is consistent
- Functionality tests:
  - All 6 TODO locations have logging
  - Log levels work correctly
  - JSON format is valid
  - Correlation IDs thread through requests
- Performance tests:
  - Measure logging overhead (must be < 1ms)
  - Test with high volume (10,000 logs/sec)
  - Verify async logging doesn't block
- Integration tests:
  - Logs can be parsed by log aggregators
  - Rotation works without data loss
  - Error recovery after disk full

## Branch Naming
`task/SEC-007-websocket-structured-logging`

## Effort Estimate
- Implementation: 2-3 hours
- Testing: 1-2 hours
- Documentation: 30 minutes