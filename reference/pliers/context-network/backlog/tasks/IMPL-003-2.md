# IMPL-003-2: JWT Authentication Foundation

## Metadata
- **Status:** ready
- **Type:** feat
- **Epic:** phase-2-core-engines
- **Priority:** high
- **Size:** medium
- **Created:** 2025-10-02
- **Parent:** IMPL-003 (decomposed)

## Branch Info
- **Branch:** [not yet created]
- **Worktree:** [not yet created]
- **PR:** [not yet created]

## Description
Implement the foundational JWT-based authentication system with user login, token generation, and basic authentication middleware. This provides the core authentication capability that other tasks will build upon.

## Acceptance Criteria
- [ ] JWT token generation using jose (ES256 algorithm)
- [ ] User login endpoint with email/password authentication
- [ ] Password hashing with bcrypt (cost factor 12+)
- [ ] Authentication middleware for protected routes
- [ ] Token validation and user context extraction

## Technical Notes

### Implementation Scope
1. **User Authentication Service**
   - Login endpoint: POST /api/auth/login
   - Password verification using bcrypt
   - JWT access token generation (15-minute expiry)
   - User lookup and validation

2. **JWT Token Service**
   - Use jose library for ES256 signing
   - Generate tokens with user ID, tenant ID, roles
   - Token validation and payload extraction
   - Proper error handling for expired/invalid tokens

3. **Authentication Middleware**
   - Extract and validate JWT from Authorization header
   - Attach user context to request object
   - Handle missing/invalid/expired tokens
   - Support optional vs. required authentication

4. **Security Considerations**
   - Constant-time password comparison
   - Secure token secret management (environment variable)
   - Protection against timing attacks
   - Rate limiting preparation (interface definition)

### Files to Create/Modify
- `packages/api/src/auth/jwt.service.ts` - JWT token operations
- `packages/api/src/auth/auth.service.ts` - User authentication logic
- `packages/api/src/auth/auth.middleware.ts` - Route protection
- `packages/api/src/auth/types.ts` - Auth type definitions
- `packages/api/src/routes/auth.routes.ts` - Authentication endpoints

### Dependencies to Install
```json
{
  "jose": "^5.2.0",
  "bcrypt": "^5.1.1",
  "@types/bcrypt": "^5.0.2"
}
```

## Branch Naming
**Suggested Branch:** `task/IMPL-003-2-jwt-auth-foundation`

## Dependencies
- ✅ IMPL-003-1: Authentication System Assessment (MUST COMPLETE FIRST)
- ✅ IMPL-001: Database setup (COMPLETED)
- ✅ DOC-005: Security architecture (COMPLETED)

## Testing Strategy

### Unit Tests Required
1. **JWT Service Tests**
   - Token generation with valid payload
   - Token validation success and failure
   - Expired token handling
   - Invalid signature detection
   - Malformed token handling

2. **Auth Service Tests**
   - Successful login with correct credentials
   - Failed login with wrong password
   - Failed login with non-existent user
   - Password hashing verification
   - Token payload correctness

3. **Middleware Tests**
   - Valid token allows access
   - Missing token blocks access
   - Invalid token blocks access
   - Expired token blocks access
   - User context is properly attached

### Integration Tests
- Full login flow end-to-end
- Protected route access with valid token
- Protected route denial without token

### Security Tests
- Timing attack resistance in password comparison
- Token tampering detection
- Token reuse after expiry

## Estimated Effort
- **Time:** 1-2 days
- **Complexity:** Medium
- **Files:** 5-8 files (new + modifications)
- **Lines:** 300-400 lines total

## Follow-up Tasks
- IMPL-003-3: Token Management and Refresh (builds on this foundation)
- IMPL-003-4: RBAC System (uses auth middleware)
