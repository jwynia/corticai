# IMPL-003-5: Multi-Tenancy Row-Level Security

## Metadata
- **Status:** in-review
- **Type:** feat
- **Epic:** phase-2-core-engines
- **Priority:** high
- **Size:** medium
- **Created:** 2025-10-02
- **Parent:** IMPL-003 (decomposed)

## Branch Info
- **Branch:** task/IMPL-003-5-multi-tenancy-rls
- **Worktree:** .worktrees/IMPL-003-5
- **PR:** #31

## Description
Implement multi-tenant data isolation using row-level security and tenant context management. Ensures complete data separation between tenants at the database level.

## Acceptance Criteria
- [x] Tenant context middleware for all requests
- [x] Row-level security policies on multi-tenant tables
- [x] Tenant isolation validation tests
- [x] Cross-tenant access prevention
- [x] Tenant-scoped queries throughout application

## Technical Notes

### Implementation Scope
1. **Tenant Context Management**
   - Extract tenant ID from authenticated user
   - Tenant context middleware (runs after auth)
   - Request-scoped tenant context storage
   - Tenant switching for admin users (with audit)

2. **Database Row-Level Security**
   - PostgreSQL RLS policies on all multi-tenant tables
   - Default deny policy
   - Tenant-scoped SELECT/INSERT/UPDATE/DELETE policies
   - Database user context for RLS

3. **Tenant Isolation Service**
   - Validate user belongs to tenant
   - Get user's accessible tenants
   - Tenant membership management
   - Cross-tenant access prevention

4. **Query Helpers**
   - Automatic tenant filtering in base queries
   - Tenant-scoped repository methods
   - Override mechanism for super-admin queries
   - Validation helpers

### Files to Create/Modify
- `packages/api/src/auth/tenant-context.middleware.ts` - Tenant extraction
- `packages/api/src/auth/tenant.service.ts` - Tenant management
- `packages/api/src/database/tenant-scoped.repository.ts` - Base repository
- Database migrations for RLS policies
- Update all multi-tenant models with tenant_id

### Database Schema Changes
```sql
-- Add tenant_id to multi-tenant tables
ALTER TABLE users ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE forms ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE events ADD COLUMN tenant_id UUID REFERENCES tenants(id);

-- Enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE forms ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY tenant_isolation ON users
  USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation ON forms
  USING (tenant_id = current_setting('app.current_tenant_id')::uuid);

CREATE POLICY tenant_isolation ON events
  USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
```

### Security Considerations
- Never trust client-provided tenant ID
- Always derive tenant from authenticated user
- Audit all tenant context changes
- Prevent tenant ID tampering
- Test cross-tenant data leakage thoroughly

## Branch Naming
**Suggested Branch:** `task/IMPL-003-5-multi-tenancy-rls`

## Dependencies
- ✅ IMPL-003-2: JWT Authentication Foundation (MUST COMPLETE FIRST)
- ✅ IMPL-003-4: RBAC System (tenant-scoped roles)
- ✅ IMPL-003-1: Authentication System Assessment

## Testing Strategy

### Unit Tests Required
1. **Tenant Context Tests**
   - Extract tenant from user context
   - Set tenant in request context
   - Validate tenant membership
   - Reject invalid tenant access

2. **Tenant Service Tests**
   - Get user's tenants
   - Validate user in tenant
   - Admin cross-tenant access
   - Tenant switching with audit

3. **Repository Tests**
   - Automatic tenant filtering
   - Tenant-scoped create/update/delete
   - Super-admin override queries

### Integration Tests
- User can only access their tenant's data
- Cross-tenant query returns zero results
- Admin can access multiple tenants
- Tenant switching is audited

### Security Tests (CRITICAL)
1. **Tenant Isolation Tests**
   - Create data in tenant A
   - Attempt access from tenant B user
   - Verify zero results
   - Test all major entities

2. **Attack Scenarios**
   - Attempt to modify tenant_id in request
   - Attempt SQL injection to bypass RLS
   - Attempt to query without tenant context
   - Verify all attacks fail

3. **RLS Validation**
   - Test RLS policies are active
   - Test bypass attempts fail
   - Test super-admin override works

## Estimated Effort
- **Time:** 2-3 days
- **Complexity:** Medium (high security sensitivity)
- **Files:** 5-8 files (new + modifications + migrations)
- **Lines:** 300-400 lines total

## Follow-up Tasks
- IMPL-003-6: Security Hardening (adds tenant-scoped rate limiting)
