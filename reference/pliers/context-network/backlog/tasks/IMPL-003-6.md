# IMPL-003-6: Security Hardening and Rate Limiting

## Metadata
- **Status:** ready
- **Type:** feat
- **Epic:** phase-2-core-engines
- **Priority:** high
- **Size:** medium
- **Created:** 2025-10-02
- **Parent:** IMPL-003 (decomposed)

## Branch Info
- **Branch:** [not yet created]
- **Worktree:** [not yet created]
- **PR:** [not yet created]

## Description
Implement comprehensive security hardening including rate limiting, security headers, audit logging, and protection against common attacks. This task focuses on defense-in-depth security measures.

## Acceptance Criteria
- [ ] Rate limiting per user and tenant (sliding window algorithm)
- [ ] Security headers middleware (CORS, CSP, HSTS, etc.)
- [ ] Audit logging for all authentication events
- [ ] Protection against brute force attacks
- [ ] Security event monitoring

## Technical Notes

### Implementation Scope
1. **Rate Limiting**
   - Sliding window rate limiter
   - Per-user rate limits (authenticated requests)
   - Per-IP rate limits (unauthenticated requests)
   - Per-tenant rate limits (global tenant quotas)
   - Configurable limits per endpoint
   - Redis backend (future) with in-memory fallback

2. **Security Headers**
   - CORS configuration with whitelist
   - Content Security Policy (CSP)
   - HTTP Strict Transport Security (HSTS)
   - X-Content-Type-Options: nosniff
   - X-Frame-Options: DENY
   - X-XSS-Protection
   - Referrer-Policy

3. **Audit Logging**
   - Log all authentication events (login, logout, refresh)
   - Log authorization failures
   - Log rate limit violations
   - Log security events (token reuse, suspicious activity)
   - Structured logging with context
   - Audit log retention policy

4. **Attack Protection**
   - Brute force protection on login
   - Account lockout after N failed attempts
   - Suspicious activity detection
   - IP-based blocking (temporary)

### Files to Create/Modify
- `packages/api/src/security/rate-limiter.service.ts` - Rate limiting logic
- `packages/api/src/security/rate-limiter.middleware.ts` - Rate limit middleware
- `packages/api/src/security/security-headers.middleware.ts` - Security headers
- `packages/api/src/security/audit-logger.service.ts` - Audit logging
- `packages/api/src/security/brute-force-protection.ts` - Attack prevention
- `packages/api/src/security/types.ts` - Security type definitions

### Rate Limiting Configuration
```typescript
const rateLimits = {
  login: { requests: 5, window: '15m', lockout: '1h' },
  refresh: { requests: 10, window: '15m' },
  api: { requests: 100, window: '15m' },
  apiPerTenant: { requests: 10000, window: '1h' }
};
```

### Security Headers Configuration
```typescript
const securityHeaders = {
  cors: {
    origin: process.env.ALLOWED_ORIGINS?.split(',') || [],
    credentials: true
  },
  csp: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
};
```

## Branch Naming
**Suggested Branch:** `task/IMPL-003-6-security-hardening`

## Dependencies
- ✅ IMPL-003-2: JWT Authentication Foundation (MUST COMPLETE FIRST)
- ✅ IMPL-003-3: Token Management (audit refresh events)
- ✅ IMPL-003-5: Multi-Tenancy (tenant-scoped rate limits)

## Testing Strategy

### Unit Tests Required
1. **Rate Limiter Tests**
   - Allow requests within limit
   - Block requests over limit
   - Sliding window calculation
   - Multiple users don't affect each other
   - Rate limit reset after window

2. **Security Headers Tests**
   - All required headers present
   - CORS whitelist enforcement
   - CSP policy correctness

3. **Audit Logger Tests**
   - Log authentication events
   - Log authorization failures
   - Log structure and format
   - Log retention

4. **Brute Force Protection Tests**
   - Account lockout after N failures
   - Lockout duration
   - Successful login resets counter
   - IP-based blocking

### Integration Tests
- Rate limiting across multiple requests
- Rate limit varies by endpoint
- Security headers on all responses
- Audit log captures real events

### Security Tests
1. **Brute Force Attack Simulation**
   - Attempt 100 logins with wrong password
   - Verify account locks after N attempts
   - Verify lockout duration works
   - Verify legitimate user can't login during lockout

2. **Rate Limit Bypass Attempts**
   - Attempt to exceed rate limits
   - Verify blocking works
   - Attempt with different IPs (should still block per user)

3. **Header Injection Tests**
   - Verify security headers can't be overridden
   - Test CSP violations are blocked

## Estimated Effort
- **Time:** 2-3 days
- **Complexity:** Medium
- **Files:** 6-8 files (new + modifications)
- **Lines:** 350-450 lines total

## Follow-up Tasks
- IMPL-003-7: Extended Authentication Methods (uses rate limiting)
- PERF-004: Adaptive Event Batching (may integrate with rate limiter)
