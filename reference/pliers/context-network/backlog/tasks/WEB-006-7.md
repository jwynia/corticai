# WEB-006-7: Real-time Widget Updates

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** web-dashboard
- **Priority:** medium
- **Size:** medium
- **Estimated Effort:** 3-5 days
- **Created:** 2025-09-30
- **Parent Task:** WEB-006 (archived - oversized)
- **Branch:** feat/WEB-006-7-realtime-widget-updates

## Description
Implement real-time widget data updates using WebSocket connections for widgets that require live data. This includes subscription management, automatic reconnection, and handling of partial updates for efficiency.

## Acceptance Criteria
- [ ] Implement WebSocket subscription for widgets
- [ ] Add automatic reconnection on disconnect
- [ ] Support partial data updates
- [ ] Implement subscription cleanup on widget unmount
- [ ] Add real-time indicator to widget header

## Technical Notes
- Use existing WebSocket infrastructure if available
- Subscribe per-widget rather than global subscription
- Handle connection state (connecting, connected, disconnected)
- Support both full and partial data updates

## Implementation Approach
```typescript
const useWidgetRealtime = (widget: Widget) => {
  const [data, setData] = useState(null);
  const [connectionState, setConnectionState] = useState<'disconnected' | 'connecting' | 'connected'>('disconnected');

  useEffect(() => {
    if (!widget.dataSource.realTime) return;

    setConnectionState('connecting');
    const ws = new WebSocket(`/api/widgets/${widget.id}/subscribe`);

    ws.onopen = () => {
      setConnectionState('connected');
    };

    ws.onmessage = (event) => {
      const update = JSON.parse(event.data);

      switch (update.type) {
        case 'data-update':
          setData(update.data);
          break;
        case 'partial-update':
          setData(prev => mergeData(prev, update.data));
          break;
        case 'error':
          console.error('Widget update error:', update.message);
          break;
      }
    };

    ws.onerror = () => {
      setConnectionState('disconnected');
    };

    ws.onclose = () => {
      setConnectionState('disconnected');
      // Attempt reconnection after delay
      setTimeout(() => {
        if (widget.dataSource.realTime) {
          // Retry connection
        }
      }, 5000);
    };

    return () => {
      ws.close();
    };
  }, [widget.id, widget.dataSource.realTime]);

  return { data, connectionState };
};
```

## Dependencies
- WEB-006-6: Data Source Configuration (real-time flag)
- WEB-006-2: Widget Framework and Wrapper (integration point)

## Follows After
- WEB-006-6: Data Source Configuration

## Enables
- Live dashboard updates
- Real-time monitoring capabilities

## Testing Strategy
- Unit tests for WebSocket connection logic
- Test reconnection on disconnect
- Verify partial updates merge correctly
- Test subscription cleanup

## Success Metrics
- WebSocket connections establish successfully
- Widgets receive real-time updates
- Automatic reconnection works
- No memory leaks from unclosed connections

## Branch Naming
`feat/WEB-006-7-realtime-widget-updates`