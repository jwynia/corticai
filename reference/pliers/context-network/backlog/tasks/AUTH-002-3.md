# AUTH-002-3: Magic Link Verification and Rate Limiting

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** passwordless-authentication
- **Priority:** high
- **Size:** medium
- **Estimated Effort:** 3-5 days
- **Created:** 2025-10-01
- **Parent Task:** AUTH-002 (archived - oversized)
- **Branch:** feat/AUTH-002-3-magic-link-verification-rate-limiting

## Description
Implement the core magic link authentication endpoints including request, verification, and resend functionality. Add comprehensive rate limiting to prevent abuse and validate redirect targets to prevent open redirect attacks.

## Acceptance Criteria
- [ ] Create POST /api/auth/magic-link/request endpoint with rate limiting
- [ ] Create GET /api/auth/magic-link/verify/:token endpoint with redirect validation
- [ ] Implement rate limiting (3-5 requests per hour per user, 10 per hour per IP)
- [ ] Implement redirect target validation against whitelist
- [ ] Add resend functionality with exponential backoff

## Technical Notes
- Rate limiting must track both user and IP address
- Redirect validation prevents open redirect vulnerabilities
- Token verification requires HTTPS in production
- Resend functionality enforces minimum delay (30 seconds)
- All endpoints return consistent error responses

## Implementation Approach

### Magic Link Request Endpoint
```typescript
// POST /api/auth/magic-link/request
// - Rate limit: 5 requests/hour by email or IP
// - Validate email format and redirect URL
// - Find or create user
// - Generate token via magicLinkTokenService.createToken()
// - Construct magic link with token and optional redirect
// - Send email via emailService.sendMagicLink()
// - Return success with expiration time
```

### Magic Link Verification Endpoint
```typescript
// GET /api/auth/magic-link/verify/:token
// - Require HTTPS in production
// - Verify token via magicLinkTokenService.verifyToken()
// - Mark token as used (single-use enforcement)
// - Create JWT session via authService.createSession()
// - Validate redirect URL against whitelist
// - Set secure session cookie
// - Redirect to validated URL or default /dashboard
```

### Redirect Validation
```typescript
// Whitelist: APP_DOMAIN, localhost:3000, 127.0.0.1:3000
// - Same-origin redirects allowed by default
// - Cross-origin must be in whitelist
// - Prevent javascript: and data: URLs
// - Only allow http: and https: protocols
```

### Resend Functionality
```typescript
// POST /api/auth/magic-link/resend
// - Track resend state in cache (lastSentAt, attemptCount)
// - Enforce exponential backoff: 30s * 2^(attempts-1), max 5 minutes
// - Return 429 if too soon with retryAfter
// - Update state and reuse request handler logic
```

## Dependencies
- AUTH-002-1: Magic Link Token Infrastructure
- AUTH-002-2: Email Delivery and Templates

## Follows After
- AUTH-002-1: Magic Link Token Infrastructure
- AUTH-002-2: Email Delivery and Templates

## Enables
- AUTH-002-4: Cleanup, Logging, and User Experience

## Testing Strategy
- Test rate limiting with multiple requests
- Test redirect validation with various URLs
- Test token verification (valid, expired, used, invalid)
- Test resend exponential backoff
- Test HTTPS enforcement in production mode
- Security tests for open redirect prevention
- Integration tests for complete auth flow
- Test error handling for edge cases

## Success Metrics
- Rate limiting prevents abuse (>95% of abuse blocked)
- Redirect validation prevents open redirects (100%)
- Token verification is secure and accurate
- Resend backoff prevents spam
- Error messages are user-friendly and secure

## Security Considerations
- Rate limit by both email and IP address
- Validate redirect URLs against whitelist
- Prevent open redirect attacks
- Require HTTPS in production
- Log all authentication attempts
- Use constant-time comparison for tokens
- Clear error messages without leaking information

## Branch Naming
`feat/AUTH-002-3-magic-link-verification-rate-limiting`
