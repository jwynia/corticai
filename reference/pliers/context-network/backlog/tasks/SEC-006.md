# SEC-006: Improve Type Safety in WebSocket Authentication

## Metadata
- **Status:** completed
- **Type:** improvement
- **Epic:** code-quality
- **Priority:** high
- **Size:** medium
- **Created:** 2025-09-24
- **Branch:** task/SEC-006-type-safety

## Grooming Reality Check (2025-09-26)
âœ… **ALREADY IMPLEMENTED:** WebSocket authentication at `/src/lib/event-engine/websocket-auth.ts` has comprehensive TypeScript types.
**Reality:** All required interfaces exist: `AuthenticatedWebSocket`, `WebSocketAuthConfig`, `RateLimiter`, `AuthResult` - no `any` types found.

## Description
The WebSocket authentication module uses `any` types in several places, reducing type safety and increasing the risk of runtime errors. This task improves type definitions throughout the module.

## Acceptance Criteria
- [ ] Replace all 4 instances of `any` type in websocket-auth.ts
- [ ] Create comprehensive interfaces:
  - `JWTPayload` for token verification results
  - `WebSocketMessage` discriminated union for all message types
  - `AuthenticatedWebSocket` extending base WebSocket
  - `WebSocketError` for error handling
- [ ] Add type guard functions:
  - `isValidWebSocketMessage(msg: unknown): msg is WebSocketMessage`
  - `isAuthenticatedWebSocket(ws: WebSocket): ws is AuthenticatedWebSocket`
- [ ] Enable TypeScript strict mode for the module
- [ ] Ensure 100% type coverage (no implicit any)
- [ ] Update all tests to use proper types

## Technical Notes
- Main issues in `websocket-auth.ts`:
  - Line 139: `verify()` result cast as `any`
  - Line 162: Error parameter typed as `any`
  - Line 390: Message parameter typed as `any`
  - Line 286: Sanitization recursive handling
- Need proper JWT payload interface
- Need message type discriminated union

## Dependencies
- SEC-004: WebSocket Authentication (completed)

## Implementation Notes
```typescript
// Complete type definitions needed:
interface JWTPayload {
  user: User;
  exp?: number;
  iat?: number;
  jti?: string;
  roles?: string[];
}

type WebSocketMessage =
  | { type: 'subscribe'; eventType: string; filters?: Record<string, unknown> }
  | { type: 'unsubscribe'; eventType: string }
  | { type: 'ping'; timestamp?: number }
  | { type: 'pong'; timestamp?: number }
  | { type: 'refresh_token'; token: string }
  | { type: 'error'; code: string; message: string };

interface AuthenticatedWebSocket extends WebSocket {
  userId: string;
  user: User;
  rateLimiter: RateLimiter;
  permissions: Set<string>;
  lastActivity: Date;
}

// Type guard implementation
function isWebSocketMessage(msg: unknown): msg is WebSocketMessage {
  if (typeof msg !== 'object' || msg === null) return false;
  const obj = msg as Record<string, unknown>;
  if (typeof obj.type !== 'string') return false;

  switch (obj.type) {
    case 'subscribe':
    case 'unsubscribe':
      return typeof obj.eventType === 'string';
    case 'refresh_token':
      return typeof obj.token === 'string';
    case 'ping':
    case 'pong':
      return true;
    default:
      return false;
  }
}
```

## Testing Strategy
- Type safety tests:
  - Compile with `--strict` flag enabled
  - Run type coverage tool (aim for 100%)
  - Test type guards with valid and invalid inputs
- Message validation tests:
  - Valid messages of each type
  - Invalid message structures
  - Missing required fields
  - Extra/unknown fields
- Runtime safety tests:
  - No uncaught type errors
  - Proper error messages for type mismatches
  - Edge cases (null, undefined, arrays as messages)
- Integration tests:
  - End-to-end flow with proper types
  - JWT verification with typed results
  - Error handling with typed errors

## Branch Naming
`task/SEC-006-websocket-type-safety`

## Effort Estimate
- Implementation: 3-4 hours
- Testing: 2 hours
- Documentation: 30 minutes