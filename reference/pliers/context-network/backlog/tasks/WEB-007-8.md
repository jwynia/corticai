# WEB-007-8: Multi-Factor Authentication UI

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** web-auth
- **Priority:** medium
- **Size:** medium
- **Estimated Effort:** 3-5 days
- **Created:** 2025-09-30
- **Parent Task:** WEB-007 (archived - oversized)
- **Branch:** feat/WEB-007-8-multi-factor-authentication-ui

## Description
Implement the user interface for multi-factor authentication (MFA) setup and verification. This includes MFA enablement flow, backup codes generation, and the MFA challenge interface during login.

## Acceptance Criteria
- [ ] Create MFA setup flow in security settings
- [ ] Implement TOTP setup with QR code
- [ ] Generate and display backup codes
- [ ] Build MFA verification challenge interface
- [ ] Support MFA disablement with confirmation

## Technical Notes
- TOTP (Time-based One-Time Password) using authenticator apps
- QR code generation for easy setup
- Backup codes for account recovery
- MFA challenge appears after primary auth succeeds
- Backend integration for MFA verification

## Implementation Approach
```typescript
const MFASettings = () => {
  const { data: mfaStatus } = useQuery({
    queryKey: ['mfa-status'],
    queryFn: () => apiClient.auth.getMFAStatus()
  });

  const [isSetupOpen, setIsSetupOpen] = useState(false);

  return (
    <div className="mfa-settings">
      <Card>
        <CardHeader>
          <CardTitle>Two-Factor Authentication</CardTitle>
          <CardDescription>
            Add an extra layer of security to your account
          </CardDescription>
        </CardHeader>

        <CardContent>
          {mfaStatus?.enabled ? (
            <div className="mfa-enabled">
              <CheckCircle className="text-green-600" />
              <p>Two-factor authentication is enabled</p>
              <Button
                variant="outline"
                onClick={() => disableMFA()}
              >
                Disable MFA
              </Button>
            </div>
          ) : (
            <div className="mfa-disabled">
              <Shield className="text-gray-400" />
              <p>Two-factor authentication is not enabled</p>
              <Button onClick={() => setIsSetupOpen(true)}>
                Enable MFA
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      <MFASetupDialog open={isSetupOpen} onClose={() => setIsSetupOpen(false)} />
    </div>
  );
};

const MFASetupDialog = ({ open, onClose }: { open: boolean; onClose: () => void }) => {
  const [step, setStep] = useState<'qr' | 'verify' | 'backup'>('qr');
  const [qrCode, setQrCode] = useState('');
  const [secret, setSecret] = useState('');
  const [backupCodes, setBackupCodes] = useState<string[]>([]);

  const initSetup = async () => {
    const { qrCode, secret } = await apiClient.auth.initMFASetup();
    setQrCode(qrCode);
    setSecret(secret);
  };

  const verifyAndEnable = async (code: string) => {
    const { backupCodes } = await apiClient.auth.enableMFA(code);
    setBackupCodes(backupCodes);
    setStep('backup');
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Set Up Two-Factor Authentication</DialogTitle>
        </DialogHeader>

        {step === 'qr' && (
          <div className="mfa-qr-step">
            <p>Scan this QR code with your authenticator app:</p>
            <img src={qrCode} alt="QR Code" />
            <p className="text-sm">Or enter this code manually: {secret}</p>
            <Button onClick={() => setStep('verify')}>Next</Button>
          </div>
        )}

        {step === 'verify' && (
          <div className="mfa-verify-step">
            <p>Enter the 6-digit code from your authenticator app:</p>
            <MFACodeInput onComplete={verifyAndEnable} />
          </div>
        )}

        {step === 'backup' && (
          <div className="mfa-backup-step">
            <p>Save these backup codes in a safe place:</p>
            <div className="backup-codes">
              {backupCodes.map((code, i) => (
                <code key={i}>{code}</code>
              ))}
            </div>
            <Button onClick={onClose}>Done</Button>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
};

const MFAChallenge = ({ onSuccess }: { onSuccess: () => void }) => {
  const [code, setCode] = useState('');

  const handleVerify = async () => {
    await apiClient.auth.verifyMFAChallenge(code);
    onSuccess();
  };

  return (
    <div className="mfa-challenge">
      <Shield size={48} />
      <h2>Two-Factor Authentication</h2>
      <p>Enter the 6-digit code from your authenticator app</p>

      <MFACodeInput
        value={code}
        onChange={setCode}
        onComplete={handleVerify}
      />

      <Button variant="link">Use backup code instead</Button>
    </div>
  );
};
```

## Dependencies
- WEB-007-7: Security Settings (MFA settings location)
- WEB-003: API Client (MFA endpoints)
- WEB-002: Design System (dialog, inputs)

## Follows After
- WEB-007-7: Security Settings and Auth Methods

## Enables
- Enhanced account security with MFA

## Testing Strategy
- Unit tests for MFA setup flow
- Test QR code generation
- Verify code input validation
- Test backup codes generation
- Verify MFA challenge during login

## Success Metrics
- MFA setup flow completes successfully
- QR code displays and scans correctly
- Verification codes work
- Backup codes generate and save
- MFA challenge appears during login

## Branch Naming
`feat/WEB-007-8-multi-factor-authentication-ui`