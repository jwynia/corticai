# IMPL-003-3: Token Management and Refresh

## Metadata
- **Status:** ready
- **Type:** feat
- **Epic:** phase-2-core-engines
- **Priority:** high
- **Size:** medium
- **Created:** 2025-10-02
- **Parent:** IMPL-003 (decomposed)

## Branch Info
- **Branch:** [not yet created]
- **Worktree:** [not yet created]
- **PR:** [not yet created]

## Description
Implement refresh token mechanism with rotation, revocation, and session management. This enables secure long-lived sessions while maintaining short-lived access tokens.

## Acceptance Criteria
- [ ] Refresh token generation and storage
- [ ] Refresh token rotation on use
- [ ] Token revocation mechanism (logout)
- [ ] Refresh endpoint: POST /api/auth/refresh
- [ ] Session cleanup and expiry handling

## Technical Notes

### Implementation Scope
1. **Refresh Token Service**
   - Generate long-lived refresh tokens (7-30 days)
   - Store refresh tokens with user association
   - Implement token rotation (new token on refresh)
   - Track token family for security

2. **Token Revocation**
   - Logout endpoint: POST /api/auth/logout
   - Revoke single refresh token
   - Revoke all user sessions (logout all devices)
   - Token blacklist management (in-memory or database)

3. **Refresh Endpoint**
   - Validate refresh token
   - Rotate refresh token (invalidate old, issue new)
   - Generate new access token
   - Detect token reuse attacks

4. **Session Management**
   - Track active sessions per user
   - Session metadata (device, IP, last activity)
   - Cleanup expired sessions
   - User session listing endpoint

### Files to Create/Modify
- `packages/api/src/auth/refresh-token.service.ts` - Refresh token operations
- `packages/api/src/auth/session.service.ts` - Session management
- `packages/api/src/auth/auth.routes.ts` - Add refresh/logout endpoints
- `packages/api/src/models/refresh-token.model.ts` - Database model
- Database migration for refresh_tokens table

### Database Schema
```sql
CREATE TABLE refresh_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash VARCHAR(255) NOT NULL UNIQUE,
  family_id UUID NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  revoked_at TIMESTAMP,
  device_info JSONB,
  ip_address INET,
  created_at TIMESTAMP DEFAULT NOW(),
  INDEX idx_user_active (user_id, revoked_at, expires_at)
);
```

## Branch Naming
**Suggested Branch:** `task/IMPL-003-3-token-refresh`

## Dependencies
- ✅ IMPL-003-2: JWT Authentication Foundation (MUST COMPLETE FIRST)
- ✅ IMPL-003-1: Authentication System Assessment

## Testing Strategy

### Unit Tests Required
1. **Refresh Token Service Tests**
   - Generate refresh token
   - Validate refresh token
   - Rotate refresh token
   - Revoke refresh token
   - Detect token reuse (security test)

2. **Session Service Tests**
   - Create session
   - List user sessions
   - Revoke single session
   - Revoke all user sessions
   - Cleanup expired sessions

3. **Endpoint Tests**
   - POST /api/auth/refresh - success
   - POST /api/auth/refresh - expired token
   - POST /api/auth/refresh - revoked token
   - POST /api/auth/refresh - token reuse detection
   - POST /api/auth/logout - success
   - POST /api/auth/logout - already logged out

### Integration Tests
- Full refresh flow: login → use access token → refresh → use new token
- Logout invalidates refresh token
- Token rotation prevents reuse
- Multiple sessions per user

### Security Tests
- Refresh token reuse detection (token family breach)
- Revoked token rejection
- Expired token cleanup
- Session hijacking prevention

## Estimated Effort
- **Time:** 1-2 days
- **Complexity:** Medium
- **Files:** 5-7 files (new + modifications + migration)
- **Lines:** 350-450 lines total

## Follow-up Tasks
- IMPL-003-4: RBAC System (uses session management)
- IMPL-003-6: Security Hardening (rate limiting on refresh)
