# SEC-008: Fix Non-Awaited Async Operations

## Metadata
- **Status:** completed
- **Type:** bug
- **Epic:** code-quality
- **Priority:** high
- **Size:** small
- **Created:** 2025-09-24
- **Branch:** task/SEC-008-async-operations

## Description
The WebSocket authentication module has non-awaited async operations that could lead to race conditions or unhandled promise rejections. The `verifyClient` callback in `index.ts` doesn't properly await async operations.

## Acceptance Criteria
- [ ] Fix verifyClient callback in src/lib/event-engine/index.ts:222
- [ ] Review and fix all async operations in WebSocket module:
  - Token verification (must complete before connection)
  - Database lookups for user permissions
  - Rate limiter checks
- [ ] Add comprehensive error handling:
  - Catch and log all promise rejections
  - Return proper error codes to client
  - Prevent server crashes from unhandled errors
- [ ] Add process-level rejection handler
- [ ] Test scenarios:
  - Slow database responses
  - Failed token verifications
  - Concurrent connection attempts
  - Server shutdown during async operations

## Technical Notes
- Main issue: `index.ts:222` - verifyClient callback marked async but not awaited
- The callback system may not support async properly
- Need to investigate WebSocket library's async support
- May need to refactor to use promise-based approach

## Dependencies
- SEC-004: WebSocket Authentication (completed)

## Implementation Notes
```typescript
// Proper async handling approach:
verifyClient: (info, cb) => {
  // Don't mark as async since cb doesn't support it
  authenticateWebSocketConnection(info)
    .then(({ authenticated, user }) => {
      if (authenticated) {
        // Store user context for later use
        connectionContextMap.set(info.req, user);
        cb(true);
      } else {
        cb(false, 401, 'Authentication required');
      }
    })
    .catch(error => {
      logger.error('WebSocket verification failed', { error });
      // Always reject on error for security
      cb(false, 500, 'Internal server error');
    });
}

// Add global handler for safety:
process.on('unhandledRejection', (reason, promise) => {
  logger.error('Unhandled Promise Rejection', { reason, promise });
  // In production, may want to gracefully restart
});
```

## Testing Strategy
- Async timing tests:
  - Delay token verification by 5 seconds
  - Ensure connection waits for verification
  - Test timeout handling (30 second limit)
- Error propagation tests:
  - Throw errors at each async stage
  - Verify client receives proper error codes
  - Check server remains stable
- Concurrency tests:
  - 100 simultaneous connections
  - Mix of valid/invalid tokens
  - Verify no race conditions
- Rejection monitoring:
  - Hook into process.on('unhandledRejection')
  - Count rejections during test suite
  - Must be zero unhandled rejections

## Branch Naming
`task/SEC-008-fix-async-operations`

## Pull Request
- **PR #8**: https://github.com/jwynia/pliers/pull/8
- **Status**: Merged âœ“
- **Created**: 2025-09-25
- **Completed**: 2025-09-25
- **Merged By**: @jwynia

## Effort Estimate
- Implementation: 2 hours
- Testing: 2 hours
- Verification: 30 minutes

## Risk Assessment
**Current Risk:** HIGH - Could cause server instability
**Post-Fix Risk:** LOW - Proper async handling