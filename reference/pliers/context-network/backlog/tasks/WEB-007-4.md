# WEB-007-4: Magic Link Authentication Flow

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** web-auth
- **Priority:** high
- **Size:** small
- **Estimated Effort:** 2-3 days
- **Created:** 2025-09-30
- **Parent Task:** WEB-007 (archived - oversized)
- **Branch:** feat/WEB-007-4-magic-link-auth-flow

## Description
Implement the magic link authentication flow where users receive a secure link via email for passwordless authentication. This includes email input, link sending, confirmation screen, and link verification handling.

## Acceptance Criteria
- [ ] Create email input form for magic link request
- [ ] Implement link sending with loading states
- [ ] Build email sent confirmation screen
- [ ] Add link verification handling via URL parameter
- [ ] Support resend functionality

## Technical Notes
- Email validation using standard patterns
- Link verification happens via token URL parameter
- Show helpful tips about link expiration and device compatibility
- Consider rate limiting for resend requests

## Implementation Approach
```typescript
const MagicLinkAuthFlow = ({
  mode,
  onSuccess,
  onError
}: {
  mode: 'login' | 'register';
  onSuccess: (result: any) => void;
  onError: (error: string) => void;
}) => {
  const [email, setEmail] = useState('');
  const [step, setStep] = useState<'email' | 'sent' | 'verifying'>('email');

  const handleSendMagicLink = async (e: React.FormEvent) => {
    e.preventDefault();

    try {
      await apiClient.auth.sendMagicLink(email, mode);
      setStep('sent');
    } catch (error) {
      onError(error.message);
    }
  };

  // Listen for token in URL
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
      setStep('verifying');
      apiClient.auth.verifyMagicLink(token)
        .then(onSuccess)
        .catch(onError);
    }
  }, []);

  return (
    <div className="magic-link-flow">
      {step === 'email' && (
        <form onSubmit={handleSendMagicLink}>
          <h2>{mode === 'register' ? 'Create Account' : 'Sign In'} with Email</h2>
          <Input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="you@example.com"
            required
          />
          <Button type="submit">Send Link</Button>
        </form>
      )}

      {step === 'sent' && (
        <div className="magic-link-sent">
          <CheckCircle size={48} />
          <h3>Check your email</h3>
          <p>We sent a link to <strong>{email}</strong></p>
          <Button variant="outline" onClick={() => setStep('email')}>
            Resend
          </Button>
        </div>
      )}

      {step === 'verifying' && (
        <div className="magic-link-verifying">
          <Loader2 size={48} className="animate-spin" />
          <h3>Verifying...</h3>
        </div>
      )}
    </div>
  );
};
```

## Dependencies
- WEB-007-1: Authentication Context
- WEB-003: API Client (magic link endpoints)
- AUTH-005: Hybrid Auth Backend (for magic links)

## Follows After
- WEB-007-2: Authentication Method Selector

## Enables
- Email-based passwordless authentication

## Testing Strategy
- Unit tests for email form
- Test link sending flow
- Verify token parsing from URL
- Test resend functionality
- Verify error handling

## Success Metrics
- Email form validates input
- Magic links send successfully
- Confirmation screen displays
- Token verification works
- Resend functionality works

## Branch Naming
`feat/WEB-007-4-magic-link-auth-flow`