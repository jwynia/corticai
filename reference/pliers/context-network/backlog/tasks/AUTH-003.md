# AUTH-003: WebSocket Authentication Extension

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** passwordless-authentication
- **Priority:** medium
- **Size:** small
- **Created:** 2025-09-25
- **Branch:** task/AUTH-003-websocket-auth-extension

## Description
Extend the existing WebSocket authentication system to support tokens generated by passwordless authentication methods (magic links and future passkeys). This ensures seamless integration with the existing event engine.

## Acceptance Criteria
- [ ] Extend `authenticateWebSocketConnection` to handle passwordless tokens
- [ ] Add token type detection (JWT vs passwordless)
- [ ] Implement passwordless token validation logic
- [ ] Maintain backwards compatibility with existing JWT tokens
- [ ] Add proper error handling for invalid passwordless tokens
- [ ] Update WebSocket auth tests to cover new token types
- [ ] Ensure connection context mapping works with passwordless auth
- [ ] Add logging for passwordless WebSocket authentications

## Technical Notes
- Build on existing WebSocket auth in `src/lib/event-engine/websocket-auth.ts`
- Passwordless tokens should have different format/structure than JWT
- Use existing connection context mapping for user association
- Follow established error handling patterns

## Dependencies
- AUTH-002: Magic Link Authentication Implementation
- SEC-008: Async Operations Fix (completed)

## Security Impact
- **Current Risk:** LOW - Extension of existing secure system
- **Post-Implementation Risk:** LOW - Maintains existing security model
- **Validation:** Passwordless tokens must have same security guarantees as JWT

## Implementation Approach
```typescript
// In src/lib/event-engine/websocket-auth.ts
async authenticateWebSocketConnection(info: any) {
  const token = this.extractTokenFromRequest(info.req);

  if (!token) {
    return { authenticated: false, user: null };
  }

  // Existing JWT validation
  if (this.isJWTToken(token)) {
    return this.validateJWTToken(token);
  }

  // New: Passwordless token validation
  if (this.isPasswordlessToken(token)) {
    return this.validatePasswordlessToken(token);
  }

  return { authenticated: false, user: null };
}

private isPasswordlessToken(token: string): boolean {
  // Token format detection logic
}

private async validatePasswordlessToken(token: string) {
  // Passwordless token validation logic
}
```

## Testing Strategy
- Unit tests for token type detection
- Integration tests with magic link tokens
- Backwards compatibility tests with existing JWT tokens
- WebSocket connection tests with both token types
- Error handling tests for invalid tokens
- Performance tests to ensure no regression

## References
- Existing implementation: src/lib/event-engine/websocket-auth.ts
- Related task: SEC-008 (async WebSocket auth improvements)

## Branch Naming
`task/AUTH-003-websocket-passwordless-auth`