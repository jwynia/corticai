# WEB-007-9: Replace Mock Authentication with Real API Integration

## Metadata
- **Status:** ready
- **Type:** feature
- **Epic:** web-auth
- **Priority:** high
- **Size:** medium
- **Estimated Effort:** 3-5 days
- **Created:** 2025-10-01
- **Created From:** PR #26 code review feedback
- **Parent Epic:** WEB-007 (Authentication UI)
- **Related Tasks:** WEB-007-1, AUTH-001

## Description
Replace the mock authentication logic in AuthProvider with real API integration. Currently, the provider uses simulated authentication with predictable patterns and hardcoded delays, which is only suitable for development and testing.

## Problem Statement
From PR #26 code review:
> **Mock Authentication Logic** - Mock logic contains predictable patterns that could leak to production. Ensure this is replaced before production deployment.

Current mock implementation in `auth-provider.tsx`:
```typescript
const login = async (email: string, password: string) => {
  // Simulated API call delay
  await new Promise(resolve => setTimeout(resolve, 100));

  // Mock authentication logic
  if (email.includes('invalid') || password === 'wrong') {
    throw new Error('Invalid credentials');
  }

  const user: User = {
    id: Math.random().toString(36).substring(7),
    email,
    name: email.split('@')[0],
  };
  // ...
};
```

This mock logic:
- Uses predictable email patterns for authentication success/failure
- Generates random user IDs instead of real backend IDs
- Has no actual credential verification
- Could accidentally leak to production if not replaced

## Acceptance Criteria
- [ ] Integrate with real authentication API endpoints
- [ ] Replace mock login logic with API calls to `/api/auth/login`
- [ ] Replace mock register logic with API calls to `/api/auth/register`
- [ ] Replace mock logout with API calls to `/api/auth/logout`
- [ ] Handle real API errors and status codes
- [ ] Remove all mock delay timeouts
- [ ] Remove predictable email pattern checks
- [ ] Update error handling for real API responses
- [ ] Maintain backward compatibility with existing tests (via mocks)

## Technical Approach

### API Integration Points
```typescript
import { apiClient } from '@/lib/api/client';

const login = async (email: string, password: string) => {
  setState(prev => ({ ...prev, loading: true, error: null }));

  try {
    // Real API call
    const response = await apiClient.post('/auth/login', {
      email,
      password,
    });

    const user: User = response.data.user;

    setState(prev => ({
      ...prev,
      isAuthenticated: true,
      user,
      loading: false,
      error: null,
    }));
  } catch (error) {
    const errorMessage = error.response?.data?.message || 'Login failed';
    setState(prev => ({
      ...prev,
      loading: false,
      error: errorMessage,
      isAuthenticated: false,
      user: null,
    }));
    throw error;
  }
};
```

### Error Handling
Map backend error responses to user-friendly messages:
- `401 Unauthorized` → "Invalid email or password"
- `429 Too Many Requests` → "Too many login attempts. Please try again later."
- `500 Internal Server Error` → "Login failed. Please try again."
- Network errors → "Connection failed. Please check your internet."

### Testing Strategy
Mock API responses in tests:
```typescript
vi.mock('@/lib/api/client', () => ({
  apiClient: {
    post: vi.fn(),
  },
}));

it('should successfully log in a user', async () => {
  vi.mocked(apiClient.post).mockResolvedValue({
    data: { user: { id: '123', email: 'test@example.com', name: 'Test' } }
  });

  // Test implementation...
});
```

## Implementation Steps
1. Update `login` function to call real API
2. Update `register` function to call real API
3. Update `logout` function to call real API
4. Remove mock delay timeouts
5. Remove predictable pattern checks
6. Update error handling for API responses
7. Update test mocks to mock API client instead of delays
8. Add API error mapping logic
9. Test all auth flows end-to-end
10. Verify proper error states

## Files to Modify
- `apps/web/src/providers/auth-provider.tsx` - Replace mock logic
- `apps/web/src/providers/__tests__/auth-provider.test.tsx` - Update mocks

## Dependencies
- **AUTH-001**: Authentication Infrastructure Foundation (backend API must exist)
- **WEB-003**: API Client Integration (apiClient must be configured)
- **WEB-007-1**: Current auth provider with mock implementation

## Blocks
- All WEB-007 tasks depend on this for production readiness
- Cannot deploy authentication features without real API integration

## API Endpoints Required

### POST /api/auth/login
**Request:**
```json
{
  "email": "user@example.com",
  "password": "securepassword"
}
```

**Response (200):**
```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "User Name"
  },
  "token": "jwt-token" // If using tokens
}
```

**Errors:**
- `401`: Invalid credentials
- `429`: Rate limited
- `500`: Server error

### POST /api/auth/register
**Request:**
```json
{
  "email": "user@example.com",
  "password": "securepassword",
  "name": "User Name"
}
```

**Response (201):**
```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "User Name"
  }
}
```

### POST /api/auth/logout
**Response (200):**
```json
{
  "success": true
}
```

## Success Metrics
- Zero mock logic in production auth provider
- All auth operations call real backend APIs
- Proper error handling for all API failures
- Tests maintain 100% coverage with mocked APIs
- No predictable patterns that could leak to production

## Security Considerations
- Never log passwords in error messages
- Sanitize error messages from backend before displaying
- Implement rate limiting on client side (respect 429 responses)
- Clear sensitive data from state on errors
- Use HTTPS for all auth API calls

## Notes
- Coordinate with backend team for API endpoint availability
- May need to update based on actual API response format
- Consider implementing retry logic for network failures
- Keep mock implementation in test files for fast test execution
